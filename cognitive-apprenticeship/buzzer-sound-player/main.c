#include <avr/io.h>
#define F_CPU	16000000
#include <util/delay.h>

const uint16_t num = 131;
//const uint16_t notes[] = {50841, 40342, 50841, 40342, 33926, 33926, 50841, 40342, 50841, 40342, 33926, 33926, 25420, 26935, 30233, 33926, 38094, 30233, 33926, 38094, 40342, 45312, 50841, 50841};
const uint16_t notes[] = {20170, 20170, 0, 20170, 0, 25420, 20170, 0, 16963, 0, 0, 33926, 0, 0, 25420, 0, 0, 33926, 0, 40342, 0, 0, 30233, 0, 26935, 0, 28535, 30233, 0, 33926, 0, 20170, 0, 16963, 0, 15116, 0, 19047, 16963, 0, 20170, 0, 25420, 22655, 13467, 0, 25420, 0, 0, 33926, 0, 40342, 0, 0, 30233, 0, 26935, 0, 28535, 30233, 0, 33926, 0, 20170, 0, 16963, 15116, 0, 19047, 16963, 0, 20170, 0, 25420, 22655, 13467, 0, 0, 16963, 16015, 19047, 21384, 0, 20170, 0, 32031, 30233, 25420, 0, 30233, 25420, 22655, 0, 16963, 17981, 19047, 21384, 0, 20170, 0, 12740, 0, 12740, 12740, 0, 0, 0, 16963, 17981, 19047, 21384, 0, 20170, 0, 32031, 30233, 25420, 0, 30233, 25420, 22655, 0, 20170, 0, 0, 22655, 0, 25420, 0, 0, 0};

//const uint16_t beats[] = {8, 8, 8, 8, 16, 16, 8, 8, 8, 8, 16, 16, 8, 8, 8, 8, 16, 16, 8, 8, 8, 8, 16, 16};
const uint16_t beats[] = {8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 16, 8, 8, 16, 8, 8, 8, 8, 16, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 16, 8, 8, 8, 8, 16, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 16, 16, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 16, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 16, 16, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 16, 8, 8, 8, 8, 16, 8, 8, 16, 32};

void my_delay(uint16_t k)
{
	for (uint16_t i = 0; i < k; i++)
		_delay_ms(1);
}

void play_dal()
{
	for (uint16_t i = 0; i < num; i++) {
		uint16_t delay = ADC / 32;
		DDRB |= 1 << DDRB1;
		OCR1A = notes[i];
		ADCSRA |= 1 << ADSC;
		my_delay(beats[i] * delay);
		DDRB &= ~(1 << DDRB1);
		my_delay(delay);

	}
	DDRB &= ~(1 << DDRB1);
}

void system_init()
{
	DDRB |= 1 << DDRB1;
	DDRB |= 1 << DDRB5;

	ADMUX |= 1 << REFS0;
	ADCSRA |= 1 << ADEN;
	ADCSRA |= 1 << ADPS2;
	// Toggle
	TCCR1A |= 1 << COM1A0;
	//TCCR1A |= 1 << COM1A1;

	// Fasst PWM mode
	//TCCR1A |= 1 << WGM10;
	//TCCR1A |= 1 << WGM11;
	TCCR1B |= 1 << WGM12;
	//TCCR1B |= 1 << WGM13;

	// Clock
	//TCCR1B |= 1 << CS12;
	//TCCR1B |= 1 << CS11;
	TCCR1B |= 1 << CS10;
}

int main(void)
{
	system_init();
	/* Replace with your application code */
	while (1) {
		PINB |= 1 << PINB5;
		_delay_ms(500);
		play_dal();
	}
}
